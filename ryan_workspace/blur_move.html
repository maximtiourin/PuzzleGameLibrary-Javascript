<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="https://code.createjs.com/createjs-2015.05.21.min.js"></script>
    <script>
        var stage;
        var canvas;
        var answer;
        var image;
        var circle_size=50;
        var dragging_smoothness = 0.3;
        var blur_factor = 2;
        var use_image=true;

    function init()
    {
        canvas = document.getElementById("canvas");
        stage = new createjs.Stage(canvas);
        init_answer();

        if (!use_image)
        {
            //draw a shape
            draw_circle();
        }
        else
        {
            //draw a picture
            var image = new Image();
            image.src = "gnp.jpg";
            image.onload = handleImageLoad;
        }
        stage.update();

    }

        function draw_circle()
        {
            image=[];
            for (var i=0;i<answer.length; i++)
            {
                var circle = new createjs.Shape();
                circle.id=i;
                circle.graphics.beginFill(rand_color()).drawCircle(0,0, circle_size);
                circle.x = Math.random()*(canvas.width);
                circle.y = Math.random()*(canvas.height);
                circle.addEventListener("pressmove", circle_move);
                stage.addChild(circle);
                image.push(circle);


                var  blurFilter = new createjs.BlurFilter(0, 0, 1);
                circle.filters = [blurFilter];
                cal_blur(circle);
            }
            stage.update();
        }

        function handleImageLoad(event)
        {
            var src = event.target;
            var bitmap;
            image=[];
            for (var i=0;i<answer.length; i++)
            {
                bitmap = new createjs.Bitmap(src);
                stage.addChild(bitmap);
                bitmap.id=i;
                bitmap.x = canvas.width * Math.random();
                bitmap.y = canvas.height * Math.random();
                bitmap.regX = bitmap.image.width / 2;
                bitmap.regY = bitmap.image.height / 2;
                bitmap.scaleX= circle_size*2/bitmap.image.width;
                bitmap.scaleY= circle_size*2/bitmap.image.height;
                bitmap.addEventListener("pressmove", circle_move);
                image.push(bitmap);


                var  blurFilter = new createjs.BlurFilter(0, 0, 1);
                bitmap.filters = [blurFilter];
                bitmap.cache(0,0,canvas.width, canvas.height);
                cal_blur(bitmap);
            }
            stage.update();
        }


        function circle_move(event)
        {
            var circle = event.target;
            circle.y = circle.y + (stage.mouseY - circle.y) * dragging_smoothness;
            circle.x = circle.x + (stage.mouseX - circle.x) * dragging_smoothness;
            circle.parent.addChild(circle);
            cal_blur(circle);
            stage.update();
        }


        function cal_blur(circle)
        {
            var blurFilter= circle.filters[0];
            blurFilter.blurX = Math.abs(answer[circle.id].x - circle.x) / blur_factor;
            blurFilter.blurY = Math.abs(answer[circle.id].y - circle.y) / blur_factor;
            var bounds = blurFilter.getBounds();
            if(!use_image)
            circle.cache(-circle_size+bounds.x, -circle_size+bounds.y, 2*circle_size+bounds.width, 2*circle_size+bounds.height);
            else
            circle.cache(0,0,canvas.width, canvas.height);
        }

        function init_answer()
        {
            answer = [
                new createjs.Rectangle(canvas.width*2/10+circle_size, canvas.height*2/10+circle_size, 2*circle_size, 2*circle_size),
                new createjs.Rectangle(canvas.width*2/10+circle_size, canvas.height*6/10+circle_size, 2*circle_size, 2*circle_size),
                new createjs.Rectangle(canvas.width*6/10+circle_size, canvas.height*2/10+circle_size, 2*circle_size, 2*circle_size),
                new createjs.Rectangle(canvas.width*6/10+circle_size, canvas.height*6/10+circle_size, 2*circle_size, 2*circle_size)
            ];
            var answer_area = new createjs.Shape();
            for(var i=0;i<answer.length; i++)
            {
                answer_area.graphics.beginFill("lightgrey").drawRoundRect(answer[i].x-circle_size,answer[i].y-circle_size,answer[i].width,answer[i].width,0);
            }
            stage.addChild(answer_area);

        }

        function rand_color()
        {
            return '#'+Math.floor(Math.random()*16777215).toString(16);
        }


    </script>
</head>
<body onload="init();">
<canvas id="canvas" width="700" height="500" style="background-color:#a6a8a9"></canvas>
</body>
</html>